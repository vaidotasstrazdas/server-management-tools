name: internal-stack
services:
  postgres:
    image: postgres:17.6
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB={{GITEA_DB_NAME}}
      - POSTGRES_USER={{GITEA_DB_USER}}
      - POSTGRES_PASSWORD={{GITEA_DB_PASSWORD}}
      - TZ=UTC
    volumes:
      - /srv/postgres/data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gitea -d gitea -h 127.0.0.1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [vpn-internal]

  gitea:
    image: gitea/gitea:1.24-rootless
    container_name: gitea
    restart: unless-stopped
    environment:
      - TZ=UTC
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__server__DOMAIN=gitea.{{DOMAIN_NAME}}
      - GITEA__server__ROOT_URL=https://gitea.{{DOMAIN_NAME}}/
      - GITEA__server__PROTOCOL=http
      - GITEA__server__HTTP_ADDR=0.0.0.0
      - GITEA__server__HTTP_PORT=3000
      # Enable built-in SSH for Git-over-SSH (proxied via nginx stream)
      - GITEA__server__DISABLE_SSH=false
      - GITEA__server__START_SSH_SERVER=true
      - GITEA__server__SSH_DOMAIN=gitea.{{DOMAIN_NAME}}
      - GITEA__server__SSH_PORT=2222
      # Database (PostgreSQL)
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME={{GITEA_DB_NAME}}
      - GITEA__database__USER={{GITEA_DB_USER}}
      - GITEA__database__PASSWD={{GITEA_DB_PASSWORD}}
    volumes:
      - /srv/gitea/data:/data
      - /srv/gitea/config:/etc/gitea
    # Bind only to loopback; host nginx will proxy
    ports:
      - "127.0.0.1:3000:3000"
      - "127.0.0.1:2222:22"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/healthcheck"]
      interval: 20s
      timeout: 5s
      retries: 10
    depends_on:
      - postgres
    networks: [vpn-internal]

  pgadmin:
    image: dpage/pgadmin4:9.8.0
    container_name: pgadmin
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL={{PG_ADMIN_EMAIL}} # change
      - PGADMIN_DEFAULT_PASSWORD={{PG_ADMIN_PASSWORD}} # change
      - PGADMIN_CONFIG_SERVER_MODE=True
      - TZ=UTC
    volumes:
      - /srv/pgadmin/data:/var/lib/pgadmin
    # Bind to loopback; host nginx will proxy to HTTPS
    ports:
      - "127.0.0.1:8081:80"
    networks: [vpn-internal]

networks:
  vpn-internal:
    external: true
