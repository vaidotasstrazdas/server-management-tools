#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0;

    # Allow loopback and established sessions
    iif lo accept
    ct state established,related accept

    # Allow WireGuard itself
    udp dport 51820 accept

    # Allow DNS (for {{DOMAIN_NAME}} resolution)
    iif "wg0" udp dport 53 accept
    iif "wg0" tcp dport 53 accept

    # ===== Client-specific rules =====

    # 10.10.0.2: unrestricted (can reach everything)
    ip saddr 10.10.0.2 accept

    iif "wg0" ip saddr { 10.10.0.2, 10.10.0.3 } tcp dport 5432 accept
    iif "wg0" ip saddr { 10.10.0.2, 10.10.0.3 } tcp dport 2222 accept

    iif "wg0" tcp dport {80, 443} accept

    # ===== Default policy =====
    # Drop everything else coming from wg0
    iif "wg0" drop
  }

  chain forward {
    type filter hook forward priority 0;
    ct state established,related accept
    drop
  }

  chain output {
    type filter hook output priority 0;
    accept
  }
}

